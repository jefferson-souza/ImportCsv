unit UntImportacaoArquivos;

interface

uses
  System.Classes, Windows , Winapi.Windows, Data.DBXOdbc, Data.SqlExpr, System.SysUtils, Vcl.Dialogs;

type
  TThreadImportCsv = class( TThread)
    private
      FQrInsReg   : TSQLQuery;
      FConn       : TSQLConnection;
      FArquivo    : string;
      FTabDestino : string;
      FArqId      : Integer;

      procedure ImportArquivo;
    public
     procedure Execute; override;
     property ArqId      : Integer read FArqId write FArqId;
     property Arquivo    : string  read FArquivo write FArquivo;
     property TabDestino : string  read FTabDestino write FTabDestino;
     property Conn       : TSQLConnection write FConn;

  end;

implementation

var
  ContrleGravacao: Tcri

{ TFrmImportCsv }

//constructor TFrmImportCsv.Create(AArquivo, ATabDestino: string;
//  ACon: TSQLConnection; AOwner: TComponent);
//begin
//  inherited create(AOwner);
//  FCon        := ACon;
//  FQrInsReg   := TSQLQuery.Create(Self);
//  FArquivo    := AArquivo;
//  FTabDestino := ATabDestino;
//  FQrInsReg.SQLConnection := FCon;
//
//end;
//
//constructor TFrmImportCsv.Create(AOwner: TComponent);
//begin
//  inherited;
//{}
//end;

procedure TThreadImportCsv.Execute;
begin
  inherited;

end;

procedure TThreadImportCsv.ImportArquivo;
var
  LCVSFile    : TextFile;
  LLinha      : string;
  i,j         : Integer;
  LPosiTAbAnt : Integer;
  LLinIns     : string;
  LErros      : TStringList;
  Trans       : TTransactionDesc;
  LToken      : string;

begin
  LErros := TStringList.Create;
  LErros.Add('Logando erros de importação para arquivo: ' + FArquivo);

  AssignFile(LCVSFile, FArquivo);
  Reset(LCVSFile);
  i:= 0;

//  while not Eof(LCVSFile) do
  while i < 5 do
  begin
    ReadLn(LCVSFile, LLinha);
    LPosiTAbAnt := 0;

    if (i <> 0) then
    begin
      j := 1;

     for j := 1 to Length(LLinha) do
      begin
        if (LLinha[j] = ',') then LLinha[j] := '.';

        if (LLinha[j] = #9 ) or ( j = Length(LLinha)) then
        begin
          if ( LPosiTAbAnt = 0)    then
          begin
            LToken  := Copy(LLinha, LPosiTAbAnt   , j-1);
            if (LToken = #0) then
            begin
              LToken := 'null';
              LLinIns := LLinIns + LToken + ',';
            end
            else
              LLinIns := LLinIns + QuotedStr(LToken) + ',';
          end
          else
          if ( j = Length(LLinha)) then
          begin
            LToken  := Copy(LLinha, LPosiTAbAnt+1 , j-LPosiTAbAnt);
            if (LToken = #0) then
            begin
              LToken := 'null';
              LLinIns := LLinIns + LToken;
            end
            else
              LLinIns := LLinIns + QuotedStr(LToken);
          end
          else
          begin
            LToken  := Copy(LLinha, LPosiTAbAnt+1 , j-1-LPosiTAbAnt);
            if (LToken = #0)then
            begin
              LToken := 'null';
              LLinIns := LLinIns + LToken + ',';
            end
            else
              LLinIns := LLinIns + QuotedStr(LToken) + ',';

          end;

          LPosiTAbAnt := j;
        end;
      end;
      try
        Trans.TransactionID := 1;
        Trans.IsolationLevel := xilREADCOMMITTED;
        FConn.StartTransaction( Trans );

        FQrInsReg.SQL.Clear;
        FQrInsReg.SQL.Text :=
          'INSERT INTO "'+FTabDestino+'" '
            + ' VALUES ( default, ' + LLinIns + ' )';

//        ShowMessage(IntToStr(i)+ '  - ' + sqlqryIns.SQL.Text);
        FQrInsReg.ExecSQL;
        FConn.Commit(Trans);
      except
        on E: Exception do
        begin
          LErros.Add(e.Message + ' - Linha:' + IntToStr(i) + ' SQL:' + FQrInsReg.SQL.Text);
          FConn.Rollback(Trans);
        end;

      end;

      LLinIns := '';
    end;
    Inc(i);

  end;

  LErros.SaveToFile('ErrosImport.txt');
  // Close the file for the last time
  CloseFile(LCVSFile);

  Beep;
  ShowMessage('Arquivo importado com sucesso!!');

  FreeAndNil(LErros);
end;

end.
